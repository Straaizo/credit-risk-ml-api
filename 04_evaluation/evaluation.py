# -*- coding: utf-8 -*-
"""evaluation.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1lOOYhZNJ5vp8XajjOhVnk9xeZWMrWOEw
"""

from google.colab import files

# Subir archivos full_dataset.parquet y model.pkl
uploaded = files.upload()

import pandas as pd
import numpy as np

from sklearn.model_selection import train_test_split
from sklearn.metrics import (
    roc_auc_score,
    classification_report,
    confusion_matrix
)

import joblib

df = pd.read_parquet("full_dataset.parquet")
model = joblib.load("model.pkl")

df.shape

X = df.drop("TARGET", axis=1)
y = df["TARGET"]

# One-hot encoding
X = pd.get_dummies(X, drop_first=True)

# Limpiar nombres de columnas
X.columns = X.columns.str.replace(r'[^A-Za-z0-9_]+', '_', regex=True)

# Manejo de nulos
X = X.fillna(0)

X_train, X_test, y_train, y_test = train_test_split(
    X, y,
    test_size=0.2,
    stratify=y,
    random_state=42
)

y_proba = model.predict_proba(X_test)[:, 1]
y_pred = model.predict(X_test)

roc_auc = roc_auc_score(y_test, y_proba)
roc_auc

confusion_matrix(y_test, y_pred)

print(classification_report(y_test, y_pred))

def credit_decision(prob):
    if prob < 0.3:
        return "APROBAR"
    elif prob < 0.6:
        return "REVISION_MANUAL"
    else:
        return "RECHAZAR"

decisions = pd.Series(y_proba).apply(credit_decision)
decisions.value_counts(normalize=True)

import json

with open("columns.json", "w") as f:
    json.dump(X.columns.tolist(), f)

from google.colab import files

files.download("columns.json")